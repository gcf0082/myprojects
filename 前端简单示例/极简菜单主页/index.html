<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>URL è·¯ç”± Tabï¼ˆéª¨æ¶å±+é˜²æŠ–ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .top-bar{background:#343a40;display:flex;align-items:center;padding:.5rem 1rem;gap:.5rem}
    .menu-spacer{width:8px}
    .nav-tabs{display:flex;gap:.25rem;margin:0;border:0}
    .nav-item{position:relative}
    .nav-link{padding:.25rem 1.4rem .25rem .6rem;font-size:.85rem;color:#fff;background:#495057;border:0;border-radius:.2rem}
    .nav-link.active{background:#007bff}
    .btn-close-inline{position:absolute;right:.5rem;top:50%;transform:translateY(-50%);width:.55rem;height:.55rem;background:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/.4rem no-repeat;cursor:pointer;opacity:.7;border:none}
    .btn-close-inline:hover{opacity:1}
    .tab-content{padding:1rem}
    /* éª¨æ¶å± */
    .skeleton{background:#e2e2e2;border-radius:4px;height:200px;width:100%;animation:fade 1.2s ease-in-out infinite}
    @keyframes fade{0%,100%{opacity:.7}50%{opacity:1}}
  </style>
</head>
<body>
<div class="top-bar">
  <div class="dropdown">
    <a class="text-light text-decoration-none dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">èœå•</a>
    <ul class="dropdown-menu" id="menuList"></ul>
  </div>
  <div class="menu-spacer"></div>
  <ul class="nav nav-tabs" id="mainTabs"></ul>
</div>
<div class="tab-content" id="mainTabContent"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* 1ï¸âƒ£ èœå•é…ç½® */
const menuItems = [
  { key: 'home',  name: 'é¦–é¡µ',    url: 'home.html',   render: 'current' },
  { key: 'services', name: 'æœåŠ¡',  url: 'services.html',render: 'current' },
  { key: 'about', name: 'å…³äº',    url: 'about.html',  render: 'iframe'  },
  { key: 'docs',  name: 'æ–‡æ¡£',    url: 'docs.html',   render: 'window'  }
];

const openedTabs = new Set();
const cache = new Map(); // ç¼“å­˜

/* 2ï¸âƒ£ å·¥å…·å‡½æ•° */
const getKey = () => decodeURIComponent(location.hash.replace('#/', ''));
const setHash = key => history.replaceState(null, null, key ? '#/' + key : './');

/* 3ï¸âƒ£ æ¸²æŸ“èœå• */
function renderMenu() {
  const ul = document.getElementById('menuList');
  menuItems.forEach(it => {
    ul.insertAdjacentHTML('beforeend',
      `<li><a class="dropdown-item" href="#/${it.key}" data-key="${it.key}">${it.name}</a></li>`);
  });
}

/* 4ï¸âƒ£ éª¨æ¶å± + é˜²æŠ–è·¯ç”± */
let hashTimer;
function handleRoute() {
  clearTimeout(hashTimer);
  hashTimer = setTimeout(() => {
    const key = getKey();
    if (!key) return;
    openTab(key);
  }, 150);
}

/* 5ï¸âƒ£ æ‰“å¼€/æ¿€æ´» tab */
function openTab(key) {
  const item = menuItems.find(m => m.key === key);
  if (!item) return;

  /* å·²æ‰“å¼€ç›´æ¥æ¿€æ´» */
  if (openedTabs.has(key)) {
    bootstrap.Tab.getInstance(document.querySelector(`#tab-${key}`)).show();
    return;
  }

  const skeleton = `<div class="skeleton"></div>`;

  /* æ–°å»º tab + éª¨æ¶å± */
  const li = document.createElement('li'); li.className = 'nav-item';
  li.innerHTML = `<button class="nav-link" id="tab-${key}" data-bs-toggle="tab" data-bs-target="#pane-${key}">${item.name}</button><span class="btn-close-inline" onclick="closeTab('${key}')"></span>`;
  document.getElementById('mainTabs').appendChild(li);

  const pane = document.createElement('div'); pane.id = `pane-${key}`; pane.className = 'tab-pane fade';
  pane.innerHTML = skeleton;
  document.getElementById('mainTabContent').appendChild(pane);
  new bootstrap.Tab(document.querySelector(`#tab-${key}`)).show();
  openedTabs.add(key);

  /* æ ¹æ®æ¸²æŸ“æ–¹å¼åŠ è½½å†…å®¹ */
  if (item.render === 'iframe') {
    pane.innerHTML = `<iframe src="${item.url}" style="width:100%;border:none;" onload="this.style.height=this.contentWindow.document.body.scrollHeight+'px'"></iframe>`;
  } else {
    if (cache.has(item.url)) {
      pane.innerHTML = cache.get(item.url);
      runScripts(pane);
      return;
    }
    fetch(item.url)
      .then(r => { if (!r.ok) throw new Error('é¡µé¢ä¸å­˜åœ¨'); return r.text(); })
      .then(html => {
        cache.set(item.url, html);
        pane.innerHTML = html;
        runScripts(pane);
      })
      .catch(err => { pane.innerHTML = `<div class="alert alert-danger">${err.message}</div>`; });
  }
}

/* 6ï¸âƒ£ å…³é—­ tab */
function closeTab(key) {
  const tabBtn = document.querySelector(`#tab-${key}`);
  const pane   = document.getElementById(`pane-${key}`);
  if (!tabBtn) return;
  tabBtn.parentElement.remove(); pane.remove(); openedTabs.delete(key);
  setHash('');
}

/* 7ï¸âƒ£ é‡æ–°æ‰§è¡Œè„šæœ¬ */
function runScripts(container) {
  container.querySelectorAll('script').forEach(old => {
    const s = document.createElement('script');
    old.src ? s.src = old.src : s.textContent = old.textContent;
    document.head.appendChild(s); old.remove();
  });
}

/* 8ï¸âƒ£ è·¯ç”±ç›‘å¬ & åˆå§‹åŒ– */
window.addEventListener('hashchange', handleRoute);
window.addEventListener('load', handleRoute);

/* 9ï¸âƒ£ èœå•ç‚¹å‡»ï¼šwindow åˆ™å¼¹çª—å¹¶æ¸…ç©º hash */
document.addEventListener('click', e => {
  if (!e.target.matches('.dropdown-item')) return;
  e.preventDefault();
  const key = e.target.dataset.key;
  const item = menuItems.find(m => m.key === key);
  if (item.render === 'window') {
    window.open(item.url, '_blank');
    setHash(''); // æ¸…ç©º hashï¼Œé˜²æ­¢åˆ·æ–°å†è§¦å‘
    return;
  }
  location.hash = '#/' + key;
});

/* ğŸ”Ÿ Alt+æ•°å­—å¿«æ·é”® */
window.addEventListener('keydown', e => {
  if (!e.altKey) return;
  const idx = parseInt(e.key) - 1;
  if (menuItems[idx]) location.hash = '#/' + menuItems[idx].key;
});

renderMenu();
</script>
</body>
</html>

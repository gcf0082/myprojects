<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>网元告警触发任务管理</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f0f2f5;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #1a1a1a;
      margin-bottom: 30px;
    }
    .step {
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    select, input[type="text"], input[type="datetime-local"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      box-sizing: border-box;
      height: 44px;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #1890ff;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #40a9ff;
    }
    .success-tip {
      margin-top: 20px;
      padding: 12px;
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      border-radius: 6px;
      color: #52c41a;
      text-align: center;
      display: none;
    }
    .loading {
      color: #999;
      font-style: italic;
    }
    .error {
      color: #f5222d;
      font-style: italic;
    }

    h2 {
      margin: 40px 0 20px;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    th {
      background: #fafafa;
      font-weight: bold;
    }
    .btn-detail {
      background: #1890ff;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-detail:hover {
      background: #40a9ff;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 8% auto;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    .modal h3 {
      margin-top: 0;
      color: #1890ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>创建网元告警触发任务</h1>

    <div class="step">
      <label for="neSelect">1. 选择网元 <span id="neStatus" class="loading">(加载中...)</span></label>
      <select id="neSelect" disabled>
        <option value="">-- 加载中，请稍候 --</option>
      </select>
    </div>

    <div class="step hidden" id="alarmStep">
      <label for="alarmSelect">2. 选择该网元上的告警 <span id="alarmStatus" class="loading"></span></label>
      <select id="alarmSelect" disabled>
        <option value="">-- 先选择网元 --</option>
      </select>
    </div>

    <div class="step hidden" id="scriptStep">
      <label for="scriptName">3. 输入触发脚本名称（必填）</label>
      <input type="text" id="scriptName" placeholder="" />
    </div>

    <div class="step hidden" id="scheduleStep">
      <label for="scheduleTime">4. 设置定时执行时间（可选，不填表示立即执行）</label>
      <input type="datetime-local" id="scheduleTime" />
    </div>

    <button id="createBtn" class="hidden" disabled>创建任务</button>

    <div class="success-tip" id="successTip">任务创建成功！任务列表已刷新。</div>

    <h2>任务列表</h2>
    <table id="taskTable">
      <thead>
        <tr>
          <th>网元</th>
          <th>告警</th>
          <th>脚本名称</th>
          <th>定时时间</th>
          <th>创建时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 任务详情模态框 -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>任务详细信息</h3>
      <p><strong>任务ID：</strong><span id="modalTaskId"></span></p>
      <p><strong>网元：</strong><span id="modalNe"></span></p>
      <p><strong>告警：</strong><span id="modalAlarm"></span></p>
      <p><strong>脚本名称：</strong><span id="modalScript"></span></p>
      <p><strong>定时时间：</strong><span id="modalSchedule"></span></p>
      <p><strong>创建时间：</strong><span id="modalCreateTime"></span></p>
    </div>
  </div>

  <script>
    const API_BASE = 'https://gcf0082.pythonanywhere.com';

    const neSelect = document.getElementById('neSelect');
    const neStatus = document.getElementById('neStatus');
    const alarmStep = document.getElementById('alarmStep');
    const alarmSelect = document.getElementById('alarmSelect');
    const alarmStatus = document.getElementById('alarmStatus');
    const scriptStep = document.getElementById('scriptStep');
    const scriptNameInput = document.getElementById('scriptName');
    const scheduleStep = document.getElementById('scheduleStep');
    const scheduleTimeInput = document.getElementById('scheduleTime');
    const createBtn = document.getElementById('createBtn');
    const successTip = document.getElementById('successTip');
    const taskTableBody = document.querySelector('#taskTable tbody');

    const modal = document.getElementById('detailModal');
    const closeBtn = document.querySelector('.close');
    const modalTaskId = document.getElementById('modalTaskId');
    const modalNe = document.getElementById('modalNe');
    const modalAlarm = document.getElementById('modalAlarm');
    const modalScript = document.getElementById('modalScript');
    const modalSchedule = document.getElementById('modalSchedule');
    const modalCreateTime = document.getElementById('modalCreateTime');

    let tasks = [];

    // 加载网元列表（必须成功）
    async function loadNetworkElements() {
      neStatus.textContent = '(加载中...)';
      neStatus.className = 'loading';
      try {
        const response = await fetch(`${API_BASE}/rest/networkElements`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        neSelect.innerHTML = '<option value="">-- 请选择网元 --</option>';
        populateSelect(neSelect, data, 'id', 'name');
        neSelect.disabled = false;
        neStatus.textContent = '';
      } catch (err) {
        neStatus.textContent = '(加载失败，请刷新页面重试)';
        neStatus.className = 'error';
        neSelect.disabled = true;
        alert('无法加载网元列表，请检查网络或联系管理员。');
      }
    }

    // 加载告警
    async function loadAlarms(neId) {
      alarmStatus.textContent = '(加载中...)';
      alarmStatus.className = 'loading';
      alarmSelect.innerHTML = '<option value="">-- 加载中 --</option>';
      alarmSelect.disabled = true;
      try {
        const response = await fetch(`${API_BASE}/rest/alarms?neId=${neId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        alarmSelect.innerHTML = '<option value="">-- 请选择告警 --</option>';
        populateSelect(alarmSelect, data, 'code', 'name');
        alarmSelect.disabled = false;
        alarmStatus.textContent = '';
      } catch (err) {
        alarmStatus.textContent = '(加载失败)';
        alarmStatus.className = 'error';
        alarmSelect.disabled = true;
        alert('无法加载该网元告警列表，请重试或联系管理员。');
      }
    }

    function populateSelect(selectEl, items, valueKey, textKey) {
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item[valueKey];
        option.textContent = `${item[textKey]} (${item[valueKey]})`;
        selectEl.appendChild(option);
      });
    }

    // 刷新任务列表
    async function refreshTaskList() {
      taskTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">加载中...</td></tr>';
      try {
        const response = await fetch(`${API_BASE}/rest/queryTasks`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const taskList = await response.json();

        tasks = taskList.map(t => ({
          id: t.taskId,
          ne: t.neName || '未知网元',
          alarm: t.alarmName || '未知告警',
          script: t.scriptName,
          schedule: t.scheduleTime ? new Date(t.scheduleTime).toLocaleString('zh-CN') : '立即执行',
          createTime: new Date(t.createTime).toLocaleString('zh-CN')
        }));

        taskTableBody.innerHTML = '';
        tasks.forEach(addTaskToTable);
        if (tasks.length === 0) {
          taskTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">暂无任务</td></tr>';
        }
      } catch (err) {
        taskTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#f5222d;">加载任务列表失败</td></tr>';
      }
    }

    function addTaskToTable(task) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${task.ne.split(' (')[0]}</td>
        <td>${task.alarm.split(' (')[0]}</td>
        <td>${task.script}</td>
        <td>${task.schedule}</td>
        <td>${task.createTime}</td>
        <td><button class="btn-detail" data-task-id="${task.id}">查看详情</button></td>
      `;
      taskTableBody.appendChild(tr);
      tr.querySelector('.btn-detail').addEventListener('click', () => showTaskDetail(task));
    }

    function showTaskDetail(task) {
      modalTaskId.textContent = task.id;
      modalNe.textContent = task.ne;
      modalAlarm.textContent = task.alarm;
      modalScript.textContent = task.script;
      modalSchedule.textContent = task.schedule;
      modalCreateTime.textContent = task.createTime;
      modal.style.display = 'block';
    }

    // 网元选择
    neSelect.addEventListener('change', async function() {
      const neId = this.value;
      alarmStep.classList.add('hidden');
      scriptStep.classList.add('hidden');
      scheduleStep.classList.add('hidden');
      createBtn.classList.add('hidden');
      createBtn.disabled = true;
      successTip.style.display = 'none';

      if (neId) {
        await loadAlarms(neId);
        alarmStep.classList.remove('hidden');
      }
    });

    // 告警选择
    alarmSelect.addEventListener('change', function() {
      if (this.value) {
        scriptStep.classList.remove('hidden');
        scheduleStep.classList.remove('hidden');
        createBtn.classList.remove('hidden');
        createBtn.disabled = false;
      } else {
        scriptStep.classList.add('hidden');
        scheduleStep.classList.add('hidden');
        createBtn.classList.add('hidden');
        createBtn.disabled = true;
      }
    });

    // 创建任务
    createBtn.addEventListener('click', async function() {
      if (!neSelect.value || !alarmSelect.value || !scriptNameInput.value.trim()) {
        alert('请完整填写必填项！');
        return;
      }

      const payload = {
        neId: neSelect.value,
        neName: neSelect.selectedOptions[0].textContent,
        alarmCode: alarmSelect.value,
        alarmName: alarmSelect.selectedOptions[0].textContent,
        scriptName: scriptNameInput.value.trim(),
        scheduleTime: scheduleTimeInput.value || null
      };

      try {
        const response = await fetch(`${API_BASE}/rest/createTask`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || '创建任务失败');
        }

        successTip.style.display = 'block';
        setTimeout(() => successTip.style.display = 'none', 3000);

        await refreshTaskList();

        document.querySelector('h2').scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        alert(err.message || '创建任务失败，请检查输入或网络');
      }
    });

    // 模态框关闭
    closeBtn.onclick = () => modal.style.display = 'none';
    window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

    // 页面初始化
    window.onload = async function() {
      await loadNetworkElements();

      const now = new Date();
      now.setMinutes(now.getMinutes() + 10);
      scheduleTimeInput.value = now.toISOString().slice(0, 16);

      await refreshTaskList();
    };
  </script>
</body>
</html>
